---
title: "Združená pravdepodonosť"
author: "Adam Harmaniak"
date: "2024-10-10"
output: html_document
---

```{r, warning=FALSE}
suppressWarnings(suppressMessages({
  library(plotly)
  library(MASS)
  library(ggplot2)
  library(reshape2)
  library(htmlwidgets)
  library(mvtnorm)
  library(dplyr)
  library(copula)
  library(viridisLite)
  library(mclust)
  library(mixtools)
  }))

datapath <- "C:/Users/Asus ROG Strix G15/STUBA/Rocnik_3/Bakalárska_práca/data/Joint_Distribution_Data.csv"
data <- read.csv(datapath, header = TRUE, sep = ",")
```


## Vizualizácia
### 2D: závislosť jednotlivých premenných
```{r, warning=FALSE}
plot(data$Height_cm, data$Weight_kg, xlab = "Height (cm)", ylab = "Weight (kg)", main = "Height vs. Weight")

```

### 3D+2D: Hustota (Premenné: výška a váha)
```{r, warning=FALSE}
height <- data$Height_cm
weight <- data$Weight_kg

kde <- kde2d(height, weight, n = 50)

plot_ly(x = kde$x, y = kde$y, z = kde$z, type = "surface") %>%
  layout(scene = list(
    xaxis = list(title = "Height (cm)"),
    yaxis = list(title = "Weight (kg)"),
    zaxis = list(title = "Density")
  ))

data_long <- melt(data, id.vars = NULL, measure.vars = c("Height_cm", "Weight_kg"),
                  variable.name = "Variable", value.name = "Value")

ggplot(data_long, aes(x = Value, color = Variable, fill = Variable)) +
  geom_density(alpha = 0.5) +
  labs(title = "Density of Height and Weight", x = "Value", y = "Density") +
  theme_minimal() +
  scale_fill_manual(values = c("blue", "green")) +
  scale_color_manual(values = c("blue", "green"))

ggplot(data, aes(x = Height_cm, y = Weight_kg)) +
  geom_point(alpha = 0.3) +
  geom_density_2d() +
  labs(x = "Height (cm)", y = "Weight (kg)", title = "2D Density Plot of Height and Weight") +
  theme_minimal()

```

## Pridanie diskrétnej náhodnej premennej do modelu (Vek)
```{r,warning=FALSE}
plot(data$Height_cm, data$Weight_kg, 
     xlab = "Height (cm)", 
     ylab = "Weight (kg)", 
     main = "Height vs. Weight by Age Category",
     col = as.numeric(as.factor(data$Age_Category)),
     pch = 19)

legend_text <- levels(as.factor(data$Age_Category))
colors <- 1:length(legend_text)

text(x = max(data$Height_cm) - 5, y = max(data$Weight_kg) - 5, labels = legend_text[1], col = colors[1], pos = 4)
text(x = max(data$Height_cm) - 5, y = max(data$Weight_kg) - 15, labels = legend_text[2], col = colors[2], pos = 4)
text(x = max(data$Height_cm) - 5, y = max(data$Weight_kg) - 25, labels = legend_text[3], col = colors[3], pos = 4)

```

### Hustota nového modelu
#### 2D
```{r,warning=FALSE}
ggplot(data, aes(x = Height_cm, y = Weight_kg, color = Age_Category)) +
  geom_point(alpha = 0.3) +
  geom_density_2d() +
  labs(x = "Height (cm)", y = "Weight (kg)", title = "2D Density Plot of Height and Weight by Age Category") +
  theme_minimal() +
  facet_wrap(~ Age_Category)
```

#### 3D
```{r,warning=FALSE}
age_categories <- unique(data$Age_Category)
plots <- list()

for (age in age_categories) {
  subset_data <- subset(data, Age_Category == age)

  kde <- kde2d(subset_data$Height_cm, subset_data$Weight_kg, n = 50)

  plot <- plot_ly(x = kde$x, y = kde$y, z = kde$z, type = "surface") %>%
    layout(
      title = paste("Density for Age Category:", age),
      scene = list(
        xaxis = list(title = "Height (cm)"),
        yaxis = list(title = "Weight (kg)"),
        zaxis = list(title = "Density")
      )
    )
  plots[[age]] <- plot
}
plots[["31-50"]]
plots[["51-70"]]
plots[["18-30"]]

```

## Hustota (váha(spojitá) vs. vek(diskrétna))
```{r,warning=FALSE}
data$Age_Num <- as.numeric(factor(data$Age_Category, levels = c("18-30", "31-50", "51-70"), labels = c(24, 40, 60)))

age <- data$Age_Num
weight <- data$Weight_kg

kde <- kde2d(age, weight, n = 50)

plot_ly(x = kde$x, y = kde$y, z = kde$z, type = "surface") %>%
  layout(scene = list(
    xaxis = list(title = "Age (Numerical)"),
    yaxis = list(title = "Weight (kg)"),
    zaxis = list(title = "Density")
  ))
```

## Použitie parametrického modelu

### 2D
```{r,warning=FALSE}
data <- read.csv(datapath, header = TRUE, sep = ",")

# Základné spracovanie vekových kategórií
data$Age_Category <- factor(data$Age_Category, levels = c("18-30", "31-50", "51-70"))

# Funkcia na výpočet hustoty pre každú vekovú kategóriu
calculate_density <- function(data, category) {
  sub_data <- filter(data, Age_Category == category)
  if (nrow(sub_data) > 1) {  # Kontrola, či existujú dáta v kategórii
    mu <- mean(sub_data$Weight_kg)
    sigma <- sd(sub_data$Weight_kg)
    x <- seq(min(data$Weight_kg), max(data$Weight_kg), length.out = 100)
    density <- dnorm(x, mean = mu, sd = sigma)
    return(data.frame(Weight = x, Density = density, Age_Category = category))
  } else {
    # Ak v kategórii nie sú dostatočné dáta, vráti prázdny dataframe
    return(data.frame(Weight = numeric(0), Density = numeric(0), Age_Category = character(0)))
  }
}

# Vypočíta hustoty pre každú kategóriu
density_data <- bind_rows(
  calculate_density(data, "18-30"),
  calculate_density(data, "31-50"),
  calculate_density(data, "51-70")
)

# 2D Vizualizácia
ggplot(density_data, aes(x = Weight, y = Density, color = Age_Category)) +
  geom_line(size = 1.2) +
  labs(title = "Hustota rozdelenia váhy podľa vekových kategórií",
       x = "Váha (kg)", y = "Hustota") +
  theme_minimal()
```

```{r,warning=FALSE}
# Načítanie dát
data <- read.csv(datapath, header = TRUE, sep = ",")

# Vytvorenie numerického veku
data$Age_numeric <- sapply(data$Age_Category, function(category) {
  if (category == "18-30") return((18 + 30) / 2)
  if (category == "31-50") return((31 + 50) / 2)
  if (category == "51-70") return((51 + 70) / 2)
  return(NA)
})

# Odstránenie chýbajúcich hodnôt
data <- na.omit(data)

# Výpočet priemerov a kovariačných matíc pre každú kategóriu
mean1 <- colMeans(filter(data, Age_Category == "18-30")[, c("Age_numeric", "Weight_kg")])
mean2 <- colMeans(filter(data, Age_Category == "31-50")[, c("Age_numeric", "Weight_kg")])
mean3 <- colMeans(filter(data, Age_Category == "51-70")[, c("Age_numeric", "Weight_kg")])

cov1 <- cov(filter(data, Age_Category == "18-30")[, c("Age_numeric", "Weight_kg")])
cov2 <- cov(filter(data, Age_Category == "31-50")[, c("Age_numeric", "Weight_kg")])
cov3 <- cov(filter(data, Age_Category == "51-70")[, c("Age_numeric", "Weight_kg")])

# Uistíme sa, že kovariačné matice sú pozitívne definitné
cov1 <- cov1 + diag(1e-6, nrow(cov1))
cov2 <- cov2 + diag(1e-6, nrow(cov2))
cov3 <- cov3 + diag(1e-6, nrow(cov3))

# Definícia mriežky
grid <- expand.grid(
  Age = seq(min(data$Age_numeric), max(data$Age_numeric), length.out = 100),
  Weight = seq(min(data$Weight_kg), max(data$Weight_kg), length.out = 100)
)

# Výpočet hustôt
grid_matrix <- as.matrix(grid[, c("Age", "Weight")])
density1 <- mvtnorm::dmvnorm(grid_matrix, mean = mean1, sigma = cov1)
density2 <- mvtnorm::dmvnorm(grid_matrix, mean = mean2, sigma = cov2)
density3 <- mvtnorm::dmvnorm(grid_matrix, mean = mean3, sigma = cov3)

# Normalizácia hustôt
density1 <- density1 / max(density1)
density2 <- density2 / max(density2)
density3 <- density3 / max(density3)

# Kombinácia hustôt
grid$Density <- (density1 + density2 + density3) / 3
grid$Density[is.na(grid$Density)] <- 0

# Transformácia hustôt na maticu
z_matrix <- matrix(grid$Density, nrow = length(unique(grid$Age)), ncol = length(unique(grid$Weight)))

# Skontrolujeme, či z_matrix obsahuje len platné hodnoty
z_matrix[is.na(z_matrix)] <- 0

# Vizualizácia
plot_ly(
  x = unique(grid$Age), y = unique(grid$Weight), z = z_matrix,
  type = "surface",
  colorscale = "Viridis"
) %>%
  layout(
    title = "3D Joint Density of Age and Weight (Normalized)",
    scene = list(
      xaxis = list(title = "Age (years)"),
      yaxis = list(title = "Weight (kg)"),
      zaxis = list(title = "Density")
    )
  )


```

