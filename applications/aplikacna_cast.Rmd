---
title: "Modelling joint probability distribution of
a mixture of continuous and categorical
random variables"
author: "Adam Harmaniak"
date: "2025-02-21"
output: html_document
---

# Pouzite kniznice

```{r,warning=FALSE}
suppressMessages(suppressWarnings({
  library(ggplot2)
  library(plotly)
  library(copula)
  library(patchwork)
  library(dplyr)
  library(tibble)
  library(MASS)
  library(randomForest)
  library(mgcv)
}))

```

# Funkcia na identifikaciu premennych

```{r, warning=FALSE}
identify_variables <- function(data) {
  variable_names <- colnames(data)
  num_variables <- length(variable_names)
  
  variable_types <- sapply(data, function(col) {
    if (is.factor(col) || is.character(col) || (is.numeric(col) && length(unique(col)) < 10)) {
      return("Diskrétna")
    } else {
      return("Spojitá")
    }
  })
  
  result_table <- tibble(
    Index = seq_len(num_variables),
    Variable_Name = variable_names,
    Variable_Type = variable_types
  )
  
  return(result_table)
}
```


# Funkcia na modelovanie a vizualizaciu zdruzeneho rozdelenia pravdepodobnosti

```{r, warning=FALSE}
model_joint_distribution <- function(data, variables) {
  print("Prvých 6 riadkov datasetu:")
  print(head(data))

  # Identifikacia diskretnych a spojitych premennych
  discrete_vars <- variables[sapply(data[, variables, drop = FALSE], function(col) is.factor(col) || is.character(col) || (is.numeric(col) && length(unique(col)) < 10))]
  continuous_vars <- setdiff(variables, discrete_vars)
  
  print(paste("Diskrétne premenné:", paste(discrete_vars, collapse=", ")))
  print(paste("Spojité premenné:", paste(continuous_vars, collapse=", ")))
  
  # Ak pocet premennych presahuje 2 => vytvorenie komplexnej tabulky pravdepodobnosti
  if (length(discrete_vars) + length(continuous_vars) > 2) {
    # Vytvorenie tabulky s frekvenciami pre diskretne premenne
    tab <- as.data.frame(table(data[, discrete_vars]))

    # Pre kazdy spojity atribut vypocitame priemerne hodnoty pre kombinacie diskretnych premennych
    for (cont_var in continuous_vars) {
        mean_values <- data %>%
            group_by(across(all_of(discrete_vars))) %>%
            summarise(Mean_Value = mean(.data[[cont_var]], na.rm = TRUE), .groups = "drop")

        # mean_values neobsahuje ziadne riadky => preskocime tuto premennu
        if (nrow(mean_values) == 0) {
            warning(paste("Žiadne dáta na výpočet priemeru pre premennú:", cont_var))
            next
        }

        # Overenie, ktore diskretne premenne existuju v tab a mean_values
        common_vars <- intersect(names(tab), discrete_vars)
        common_vars_mv <- intersect(names(mean_values), discrete_vars)

        # Existuju spolocne premenne => prevedenie na character
        if (length(common_vars) > 0) {
            tab <- tab %>%
                mutate(across(all_of(common_vars), as.character))
        }
        if (length(common_vars_mv) > 0) {
            mean_values <- mean_values %>%
                mutate(across(all_of(common_vars_mv), as.character))
        }

        # Spojenie priemernych hodnot so zakladnou tabulkou
        tab <- full_join(tab, mean_values, by = common_vars)

        # Premenovanie stlpca Mean_Value na nazov spojitej premennej
        colnames(tab)[which(colnames(tab) == "Mean_Value")] <- cont_var
    }

    # Nahrada NA vo Frequency nulami
    tab$Freq[is.na(tab$Freq)] <- 0

    # Vypocet pravdepodobnosti
    tab$Probability <- tab$Freq / sum(tab$Freq)

    # Odstranenie riadkov s nulovou frekvenciou
    tab <- tab[tab$Freq > 0, ]

    return(tab)
  }

  # Vsetky premenne diskretne a pocet je 2 => tabulka pravdepodobnosti a 2D+3D vizualizacia
  if (length(discrete_vars) == length(variables) & length(discrete_vars) == 2) {
    tab <- as.data.frame(table(data[, discrete_vars]))
    tab$Probability <- tab$Freq / sum(tab$Freq)

    tab[[discrete_vars[1]]] <- as.numeric(as.character(tab[[discrete_vars[1]]]))
    tab[[discrete_vars[2]]] <- as.numeric(as.character(tab[[discrete_vars[2]]]))

    fig_3d <- plot_ly()
    for (i in 1:nrow(tab)) {
        fig_3d <- fig_3d %>% add_trace(
            x = rep(tab[[discrete_vars[1]]][i], 2),
            y = rep(tab[[discrete_vars[2]]][i], 2),
            z = c(0, tab$Probability[i]),
            type = "scatter3d",
            mode = "lines",
            line = list(color = "blue"),
            showlegend = FALSE
        )
    }

    fig_3d <- fig_3d %>% add_trace(
        x = tab[[discrete_vars[1]]],
        y = tab[[discrete_vars[2]]],
        z = tab$Probability,
        type = "scatter3d",
        mode = "markers",
        marker = list(size = 5, color = "red"),
        name = "Pravdepodobnosti"
    )

    fig_3d <- fig_3d %>% layout(
        scene = list(
            xaxis = list(title = paste0(discrete_vars[1], " (X)")),
            yaxis = list(title = paste0(discrete_vars[2], " (Y)")),
            zaxis = list(title = "P(X, Y)")
        )
    )

    marginal_x <- tab %>%
  group_by(!!sym(discrete_vars[1])) %>%
  summarise(Prob_X = sum(Probability))

  marginal_y <- tab %>%
    group_by(!!sym(discrete_vars[2])) %>%
    summarise(Prob_Y = sum(Probability))
  
  # 2D vizualizacia
  scatter_plot <- ggplot(tab, aes_string(x = discrete_vars[1], y = discrete_vars[2], fill =   "Probability")) +
    geom_tile(color = "white") +
    scale_fill_gradient(low = "blue", high = "red") +
    labs(x = discrete_vars[1], y = discrete_vars[2], fill = "Pravdepodobnosť") +
    theme_minimal()
  
  marginal_x_plot <- ggplot(marginal_x, aes_string(x = discrete_vars[1], y = "Prob_X")) +
    geom_bar(stat = "identity", fill = "blue", alpha = 0.6) +
    labs(x = NULL, y = "P(X)") +
    theme_minimal()
  
  marginal_y_plot <- ggplot(marginal_y, aes_string(x = discrete_vars[2], y = "Prob_Y")) +
    geom_bar(stat = "identity", fill = "red", alpha = 0.6) +
    coord_flip() +
    labs(x = NULL, y = "P(Y)") +
    theme_minimal()
  
  final_plot_2d <- (marginal_x_plot + plot_spacer()) /
                   (scatter_plot + marginal_y_plot) +
                   plot_layout(widths = c(4, 1), heights = c(1, 4))

    return(list(fig_3d = fig_3d, final_plot_2d = final_plot_2d))
  }

  # 1 diskretna a 1 spojita premenna => 2D+3D vizualizacia
  if (length(discrete_vars) == 1 & length(continuous_vars) == 1) {
    mean_x <- mean(data[[continuous_vars]])
    sd_x <- sd(data[[continuous_vars]])
    
    categories <- sort(unique(as.numeric(as.factor(data[[discrete_vars]]))))
    weights <- table(data[[discrete_vars]]) / nrow(data)
    
    cor_val <- cor(data[[continuous_vars]], as.numeric(as.factor(data[[discrete_vars]])), method = "pearson")
    copula_model <- normalCopula(param = cor_val, dim = 2, dispstr = "un")
    
    copula_density <- function(x, y) {
      u1 <- pnorm(x, mean = mean_x, sd = sd_x)
      u2 <- sum(sapply(seq_along(categories), function(i) {
        pnorm(y, mean = categories[i], sd = 0.1) * weights[i]
      }))
      copula_density <- dCopula(c(u1, u2), copula = copula_model)
      x_density <- dnorm(x, mean = mean_x, sd = sd_x)
      y_density <- sum(sapply(seq_along(categories), function(i) {
        dnorm(y, mean = categories[i], sd = 0.1) * weights[i]
      }))
      copula_density * x_density * y_density
    }
    
    x_vals <- seq(min(data[[continuous_vars]]), max(data[[continuous_vars]]), length.out = 100)
    y_vals <- seq(min(categories), max(categories), length.out = 100)
    grid <- expand.grid(x = x_vals, y = y_vals)
    z_vals <- apply(as.matrix(grid), 1, function(point) {
      copula_density(point[1], point[2])
    })
    
    density_vals_matrix <- matrix(z_vals, nrow = 100, ncol = 100)
    density_vals_matrix <- density_vals_matrix / max(density_vals_matrix)
    
    fig_3d <- plot_ly(
      x = ~x_vals, y = ~y_vals, z = ~density_vals_matrix,
      type = "surface",
      colors = colorRamp(c("blue", "cyan", "yellow", "red"))
    ) %>% layout(
      title = paste("Združená hustota", continuous_vars, "a", discrete_vars, "(kopula)"),
      scene = list(
        xaxis = list(title = continuous_vars),
        yaxis = list(title = discrete_vars),
        zaxis = list(title = "Hustota")
      )
    )
    
    data[[discrete_vars]] <- as.factor(data[[discrete_vars]])

    scatter_plot <- ggplot(data, aes_string(x = continuous_vars, y = discrete_vars, color = discrete_vars)) +
      geom_point(size = 3, alpha = 0.7) +
      labs(x = continuous_vars, y = discrete_vars) +
      theme_minimal() +
      theme(legend.position = "right") +
      scale_color_brewer(palette = "Set1")
    
    x_density <- ggplot(data, aes_string(x = continuous_vars, fill = discrete_vars, color = discrete_vars)) +
      geom_density(alpha = 0.5) +
      scale_fill_brewer(palette = "Set1") +
      scale_color_brewer(palette = "Set1") +
      labs(x = NULL, y = "Hustota") +
      theme_minimal() +
      theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), legend.position = "right")
    
    y_bar <- ggplot(data, aes_string(x = discrete_vars, fill = discrete_vars)) +
      geom_bar(alpha = 0.7) +
      coord_flip() +
      scale_fill_brewer(palette = "Set1") +
      labs(x = NULL, y = "P(Y)") +
      theme_minimal() +
      theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(), legend.position = "right")
    
    final_plot_2d <- (x_density + plot_spacer()) /
                    (scatter_plot + y_bar) +
                    plot_layout(widths = c(4, 1), heights = c(1, 4))
    
    return(list(fig_3d = fig_3d, final_plot_2d = final_plot_2d))
  }
  
  # 2 spojite premenne => 2D + 3D vizualizacia
  if (length(continuous_vars) == 2) {
    mean_x <- mean(data[[continuous_vars[1]]])
    sd_x <- sd(data[[continuous_vars[1]]])
    mean_y <- mean(data[[continuous_vars[2]]])
    sd_y <- sd(data[[continuous_vars[2]]])
    
    cor_val <- cor(data[[continuous_vars[1]]], data[[continuous_vars[2]]], method = "pearson")
    copula_model <- normalCopula(param = cor_val, dim = 2, dispstr = "un")
    
    copula_density <- function(x, y) {
      u1 <- pnorm(x, mean = mean_x, sd = sd_x)
      u2 <- pnorm(y, mean = mean_y, sd = sd_y)
      
      copula_density <- dCopula(c(u1, u2), copula = copula_model)
      x_density <- dnorm(x, mean = mean_x, sd = sd_x)
      y_density <- dnorm(y, mean = mean_y, sd = sd_y)
      
      copula_density * x_density * y_density
    }
    
    x_vals <- seq(min(data[[continuous_vars[1]]]), max(data[[continuous_vars[1]]]), length.out = 100)
    y_vals <- seq(min(data[[continuous_vars[2]]]), max(data[[continuous_vars[2]]]), length.out = 100)
    grid <- expand.grid(x = x_vals, y = y_vals)

    z_vals <- apply(as.matrix(grid), 1, function(point) {
      copula_density(point[1], point[2])
    })

    density_vals_matrix <- matrix(z_vals, nrow = 100, ncol = 100)
    density_vals_matrix <- density_vals_matrix / max(density_vals_matrix)
    
    fig_3d <- plot_ly(
      x = ~x_vals, y = ~y_vals, z = ~density_vals_matrix,
      type = "surface",
      colors = colorRamp(c("blue", "cyan", "yellow", "red"))
    ) %>% layout(
      title = paste("Združená hustota", continuous_vars[1], "a", continuous_vars[2], "(kopula)"),
      scene = list(
        xaxis = list(title = continuous_vars[1]),
        yaxis = list(title = continuous_vars[2]),
        zaxis = list(title = "Hustota")
      )
    )
    
    scatter_plot <- ggplot(data, aes_string(x = continuous_vars[1], y = continuous_vars[2], color = continuous_vars[2])) +
      geom_point(size = 3, alpha = 0.7) +  
      labs(x = continuous_vars[1], y = continuous_vars[2]) +
      scale_color_gradient(low = "blue", high = "red") +
      theme_minimal()

    density_x <- ggplot(data, aes_string(x = continuous_vars[1])) +
      geom_density(fill = "blue", alpha = 0.5) +
      labs(x = NULL, y = "Hustota") +
      theme_minimal() +
      theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

    density_y <- ggplot(data, aes_string(x = continuous_vars[2])) +
      geom_density(fill = "red", alpha = 0.5) +
      coord_flip() +
      labs(x = NULL, y = "Hustota") +
      theme_minimal() +
      theme(axis.text.y = element_blank(), axis.ticks.y = element_blank())
    
    final_plot_2d <- (density_x + plot_spacer()) /
                    (scatter_plot + density_y) +
                    plot_layout(widths = c(4, 1), heights = c(1, 4))
    
    return(list(fig_3d = fig_3d, final_plot_2d = final_plot_2d))
  }
}

```

```{r, warning=FALSE}
variables <- identify_variables(mtcars)
print(variables)
```


```{r,warning=FALSE}
selected_variables <- c("cyl", "disp")
result <- model_joint_distribution(mtcars, selected_variables)
print(result)
```

